#!/usr/bin/env bash

set -o errexit
set -o nounset
set -o pipefail

echo -e "\033[44;37mPlease execute this script on the machine which contains kubeconfig file!\033[0m"
echo -n "please enter the kubeconfig absolute path ->"
read KC

datename=$(date +%Y%m%d-%H%M%S)

step(){
echo -e "\033[47;30m$1\033[0m"
}

checkreturn(){
if [ $? -ne 0 ]; then
echo -e "`date +%H:%M:%S` \033[31mThe step failed and you need to get the cluster status back manually e.g switch back to previous user!!! \033[0m"
exit 1
fi
}

if [ ! -f ${KC} ];then
echo -e "`date +%H:%M:%S` \033[31mThe kubeconfig file doesn't exit \033[0m"
exit 1
fi

step "Step 1: check whether oc client exits"
which "oc" > /dev/null
if [ $? -eq 0 ]
then
echo -e "`date +%H:%M:%S` \033[32m oc command is exist \033[0m"
else
echo -e "`date +%H:%M:%S` \033[31m oc command not exist,you should install the oc client on master \033[0m"
exit 1
fi

step "Step 2: switch to cluster-admin user"
CC=`oc config current-context --config="${KC}"`
oc login -u system:admin --config="${KC}" > /dev/null
checkreturn


step "Step 3: config 4.0 oauthconfig"


oc apply -f - <<EOF
apiVersion: v1
kind: Secret
metadata:
  name: htpass-secret
  namespace: openshift-config
data:
  htpasswd: dGVzdCUzQSUyNGFwcjElMjRqSGNNb0dmciUyNGlKeXhtU1dvRVJuOE1xRk1RYXZyUjAlMEFwbTElM0ElMjRhcHIxJTI0Qno3aC5EM2wlMjQwSXVlSlplSngvYjM1VUg2TFBqNVcuJTBBcG0yJTNBJTI0YXByMSUyNGtyZklKWVBiJTI0TmxSMWg1QmFsVVRqTUo5VzhFSXBhLiUwQXBtMyUzQSUyNGFwcjElMjRFUlgwMG44biUyNFdGNDZKMzgxTWNtaE5MZ0FLc2p6NTAlMEFwbTQlM0ElMjRhcHIxJTI0R2lacEdzTGUlMjRlWHVSYW9PY0lrOHNtMzRoRklwZWIwJTBBcG01JTNBJTI0YXByMSUyNFQzTDNSVGc3JTI0UVZsd0p2Qlc1WUI4VmtVeWkwUWJ1LiUwQXBtNiUzQSUyNGFwcjElMjRZUlZDY25wRiUyNEtzTWdxTkt2QmlBT3VleDNkOTE4LzAlMEFnZWxpdTElM0ElMjRhcHIxJTI0TFIyaWhKN2olMjQ5czlaWFk0aTg2YW42NUtHSS4xcWYxJTBBZ2VsaXUyJTNBJTI0YXByMSUyNHhTYkxQUDQxJTI0aHNXdGphRkk3UHN0aUR1RzhSVllOMCUwQWdlbGl1MyUzQSUyNGFwcjElMjRGSzQzTU9ldSUyNGh0WUI3eHZWZHozSXlUdFF6Z2h4Wi8lMEF3ZWhlJTNBJTI0YXByMSUyNC9BQXI2NnNmJTI0Mnk0N09WVDcwc3RRUHlCU0xWa1NOMCUwQWNoZWhhbmclM0ElMjRhcHIxJTI0UzkzWTN1UFMlMjRtUG9ieXpnY2RkOXMyMlJ2UWNHbFAuJTBBamlhemhhJTNBJTI0YXByMSUyNFdpeVdRSnQ2JTI0dFhUa0JSemppTnpVdmFWUFhzbnpiLyUwQXppdGFuZyUzQSUyNGFwcjElMjRkYXhXUm9VTiUyNGgwTGtzaWZrU2ZsbUs2bHUxLklTaC4lMEFqZmFuJTNBJTI0YXByMSUyNDFkM1MzakVmJTI0bnYwLjZxZ0lNbGc1N2poQXIyZVZ5LyUwQWR5YW4lM0ElMjRhcHIxJTI0S1U0UWl5bEslMjR6c2R5SkJMSms3TDVpSVNiM1QvVW0xJTBBY2hhb3lhbmclM0ElMjRhcHIxJTI0Q0l3amhNVXIlMjR6c3NyYklQNEJhVXByOTBZOGRiY0cuJTBBbHhpYSUzQSUyNGFwcjElMjR4OXAvQjBXRSUyNEJQdWI2dDlDLkdxdHJaNTNjRWVqUzElMEFzdG9yYWdlMSUzQSUyNGFwcjElMjRQNFY3M3dxbSUyNDhzLzJSZEZ1R0JSLllBRTVaV0NkUC8lMEFzdG9yYWdlMiUzQSUyNGFwcjElMjR3LmxIeXdVVyUyNEFRQWt1ZVd6U25XSHMvY0RCY2RqejElMEFzdG9yYWdlMyUzQSUyNGFwcjElMjRVdGtwMUJOeCUyNENFNk16czY3MDY1OVRrckl2R1dYZy4lMEFob25nbGklM0ElMjRhcHIxJTI0LmdTTHRXbGglMjRCRUJjS0xxZXhjRm9yNG83VzJvV1owJTBBaG9uZ2xpMSUzQSUyNGFwcjElMjRSbTlmSVFETCUyNFBpeUNJL3ZrdHBJeldTWkMwclExaTAlMEFob25nbGkyJTNBJTI0YXByMSUyNE5GVDJBbm5CJTI0Rkl1SXpGN3UwWk5TdHNENnBmTWxTMCUwQXhpdXdhbmclM0ElMjRhcHIxJTI0US5GaGhMQXIlMjRRUmg5anFVMVo3SmpkZjZCTS9BRWcuJTBBeGl1d2FuZzElM0ElMjRhcHIxJTI0bFovR0xGQ1UlMjRBV1VNekwwbFMzd3paakhXL2s2WmwuJTBBeGl1d2FuZzIlM0ElMjRhcHIxJTI0R1VFSFJNL3olMjRaSTA3Mm1OaWkya2VzUVRKcFVjMHkxJTBBd21lbmclM0ElMjRhcHIxJTI0SndPY2lWQTklMjRoZlpDYVc2NjMxUzY3eXVTNXRjTHUwJTBBd21lbmcxJTNBJTI0YXByMSUyNFJ3ZUFDZXJ4JTI0UTljRVF3RnZzWVJLTG5RVTJiaWJvMCUwQXdtZW5nMiUzQSUyNGFwcjElMjRjMGREZG5LUiUyNHpjYWgydVRpTmd4Q3g3NVhrZk9MTDAlMEF3ZWlubGl1MSUzQSUyNGFwcjElMjRSa2p3OWFaSCUyNDZCS1pEbHZXVkxONldDQmsxOVh0YS8lMEF3ZWlubGl1MiUzQSUyNGFwcjElMjR2a1hUNGg5MyUyNEloUTBxSFRvNkN1d0VNR09GaEQ4LjElMEF3ZWlubGl1MyUzQSUyNGFwcjElMjRpZ3pzRzdVRSUyNGpMWjh6dFg4RDFrVzdXSFUwVjNSZy4lMEFibWVuZyUzQSUyNGFwcjElMjQxUTNJZDdENCUyNDNyRkZWZGgvSEkzVXlnUWR1WFRFdC4lMEFqaG91JTNBJTI0YXByMSUyNEg4THZ5SnpXJTI0eS9ra1FCdXo4cG4xQjkwSS55OWpzMSUwQWpob3UxJTNBJTI0YXByMSUyNGk1azJsNG5UJTI0QW40eXJjcngxRmZpWVlKeXI0UUVPMCUwQXp6aGFvJTNBJTI0YXByMSUyNHJMaHloSktqJTI0Nk9BQ3dZSWk5L2d1RW10LkFtYTdVMSUwQXp6aGFvMSUzQSUyNGFwcjElMjRZZXhrdVB1MCUyNGExQzU0RW1HdGZ3YzNYNEVrVW5VNDElMEF6emhhbzIlM0ElMjRhcHIxJTI0RGtrMWM1TlolMjRac0FTcFF5ZFhQOGhWSW84azR4b2MwJTBBd3N1biUzQSUyNGFwcjElMjRYQUFoQmRpUiUyNFJ5TnpubkN4S0IxZk9ibDFRNTQ5MDAlMEFoYXNoYTElM0ElMjRhcHIxJTI0N3dHN2FpNUYlMjR3MHFyeWt6YzVVdEZyZlB2dGlGQVIvJTBBaGFzaGEyJTNBJTI0YXByMSUyNGlJM2JxQWRBJTI0SlJQbEhpL3lyT1IyOUMyWk11eS9zMSUwQWhhc2hhMyUzQSUyNGFwcjElMjRHR3FjcFdhcCUyNEFsR1gxTFptc0pSU054YlpRbkpKTjAlMEF4aWFvY3dhbjElM0ElMjRhcHIxJTI0bGxZbXouWWElMjQxQnduTmJOSXdUQ2ZRd1ZpUWN4MVcvJTBBeGlhb2N3YW4yJTNBJTI0YXByMSUyNC9Bak8xYXo4JTI0OTh6UndyYjJ0T3NUTDZHS1NUMkFFLyUwQXhpYW9jd2FuMyUzQSUyNGFwcjElMjRuTzF2RjdiYyUyNFFzODBlYlhsaUZpaWNySzFySlFWSS8lMEFrYWthMSUzQSUyNGFwcjElMjRIYlRzcmJoTiUyNG56dlNJdC4yd0tLa0dsLjZGVFMwUy8lMEFrYWthMiUzQSUyNGFwcjElMjQuZ0hielhXUyUyNGV4YWt0UlBBM0ZzR2ZaNXBEemZlUzElMEFrYWthMyUzQSUyNGFwcjElMjRleGc2dVZWLiUyNHZXYkFDV1pMdVQyTG5jN1AxaEszZjElMEF6aG91eTElM0ElMjRhcHIxJTI0a04zN09rQ0IlMjR1MS9ZV1pLN1NlSXZLZktqWTBmRHcuJTBBemhvdXkyJTNBJTI0YXByMSUyNGxwczE1V3BHJTI0dFg4VE1CWjNpQ0RTUnpMZm1uOVdNMSUwQXpob3V5MyUzQSUyNGFwcjElMjQuUVlVS3YxbyUyNDFTNDBaaUwyaWM1S1ZTU1JLajhhUTElMEF4eGlhMSUzQSUyNGFwcjElMjQ5bzZ1NkZUUSUyNG12V2ZBYlMuc0ZhenpHbDRzZEt1VTAlMEF4eGlhMiUzQSUyNGFwcjElMjR3UzlWck16UCUyNEdQV05sLlNtcjdteUxFYlhxVTJHTTAlMEF4eGlhMyUzQSUyNGFwcjElMjRleWVzQW84YiUyNDNzTWt1OU9oN2psN1JWNUFnMExvVTElMEFhbmxpMSUzQSUyNGFwcjElMjRKT08vQTFtZiUyNHlENjFzWkZ5V3paRFp0RDlsRWw1VC8lMEFhbmxpMiUzQSUyNGFwcjElMjRwVHZoWjVIaiUyNGZEZUw2a25rQmdSekh2YkRxNUpIWjElMEFxaXRhbmcxJTNBJTI0YXByMSUyNHo1TXptSldTJTI0T2kyWVFLcmJUUmhoNGNROE11SDJSLyUwQXFpdGFuZzIlM0ElMjRhcHIxJTI0VkZuZkpWdmIlMjRRSW5GVEh2LnZtNWRXTS9mS0I1aWovJTBBanV6aGFvMSUzQSUyNGFwcjElMjQ3amF3OVhpQSUyNGFma2d2TEs2YjkzWERSUi9IMVpQZi4lMEFqdXpoYW8yJTNBJTI0YXByMSUyNGFlaXBZS1dSJTI0UE1hczJ5NWlrSVhjaHAyY1diYmdoLiUwQXlhcGVpMSUzQSUyNGFwcjElMjRGbHYuN3NXQiUyNHdBOFpHNHRGM3NDdFl3N3ptNXhxSi8lMEF5YXBlaTIlM0ElMjRhcHIxJTI0ZU5MempEZ2ElMjRpdzZPSjJPTEE4OU1xTDIyZmZHR0svJTBBdWkxJTNBJTI0YXByMSUyNDQ4eDRoQmxGJTI0Y0xsc0JPQTJUMUVFa2FKNGdLanJnMSUwQXVpMiUzQSUyNGFwcjElMjRxWmVOYXRILyUyNC9vdUU2cHdseEoxcks4Q2x5ZmhBTzAlMEF1aTMlM0ElMjRhcHIxJTI0RzNDREpjUFklMjRNREIueDNVZXhUa3VQS2xvNXdqR1QvJTBBcGlxaW4lM0ElMjRhcHIxJTI0cElJc0RsZW4lMjRkOTUuUjNoaS5EbnJnZ28uZjhVL0swJTBBcGlxaW4xJTNBJTI0YXByMSUyNFJIeGxvUEt3JTI0NEd4VFZFTGxlRjZwSXF4ZnFkbC5xMSUwQXBpcWluMiUzQSUyNGFwcjElMjR3S2pCZkRJVCUyNElFVzBLSzNnb3daa0R4REVJc3RyMC4lMEF3ZXdhbmclM0ElMjRhcHIxJTI0dVZLNFVVdU8lMjRaM0tEUzhCNlo2Q2V0WVdDb0dGMVUvJTBBd2V3YW5nMSUzQSUyNGFwcjElMjQ5R242emh6RCUyNEMwRWU1UkNhNHVEL3hnTUptM1RlcjElMEF3ZXdhbmcyJTNBJTI0YXByMSUyNGlVclB1NzBHJTI0Qy5Nb05jdmxISUlVd2duZS5OU3lZLyUwQXpoc3VuJTNBJTI0YXByMSUyNG12ZnM1N1B3JTI0bWg3c1FNa1hzbTNWZkdxcTRENHBRMSUwQW1pbm1saSUzQSUyNGFwcjElMjRySVludHNjbyUyNHFCMDFUTTNELzQ4YnJKRFlDQW92di4lMEF3emhlbmclM0ElMjRhcHIxJTI0d3p3T2wwbFglMjQ3L0xiTVlmOHZXQi9HS3JPWUpmZ3ovJTBBd3poZW5nMSUzQSUyNGFwcjElMjRvaW9PTC5ILiUyNHV2cG9scy9ZTDA3a2JQdDdRVkVqZi8lMEFzdHVhcnRjaHVhbiUzQSUyNGFwcjElMjRIZEN1VE1NRCUyNEpvS1gweklaQXNqM0pXWS5ndVplOTAlMEF5YW5wemhhbiUzQSUyNGFwcjElMjRLT05pdTAySyUyNFVuTnpCY1E2MjJLMGFZQlZlakx0MDAlMEF5YW5wemhhbjElM0ElMjRhcHIxJTI0di9QR2p6SUElMjRYakIwSklHZE10MXFQSXc4T3pEUngvJTBBY2h1eXUlM0ElMjRhcHIxJTI0MXk1alcuVmUlMjRoNlRxTjhlQ1JlbmF5QzFTb0RYdFQvJTBBY2h1byUzQSUyNGFwcjElMjRpcHV6MDJoMiUyNFlUTVZ5VEpNOS5SUU5qZ0xQR2wvbjElMEF4aWFvY3dhbjElM0ElMjRhcHIxJTI0OHpVZGE3cUglMjQ2TXlqcUQuZUpFM1ozQzlqZzltbG4wJTBBeGlhb2N3YW4yJTNBJTI0YXByMSUyNEdwaHowRUgxJTI0MmQubndIQmNLUjBNMUJtZldNNE9SLiUwQXhpYW9jd2FuMyUzQSUyNGFwcjElMjRnY2FubkNaOSUyNFcyL2YuYndiazJFUUF3cy5KVGRmdS8lMEF4aWFvY3dhbiUzQSUyNGFwcjElMjRCeWRvWUVWSyUyNEJqM1pEaVVaNHB2b3dkd2ZWblgwcy4lMEF3ZHVhbiUzQSUyNGFwcjElMjR1QThURElPaCUyNEFwVHR4bmdVYUh5dFN3TTFpWWN1MjElMEF3ZHVhbjElM0ElMjRhcHIxJTI0elp3amU5TzclMjROYWdqQTdDc29jbXo2dlpzd3Njak4v
EOF


oc apply -f - <<EOF
apiVersion: config.openshift.io/v1
kind: OAuth
metadata:
  name: cluster
spec:
  identityProviders:
  - name: htpassidp
    challenge: true
    login: true
    mappingMethod: claim
    type: HTPasswd
    htpasswd:
      fileData:
        name: htpass-secret
EOF

sleep 30


step "Step 4: switch back to previous user"
oc config use-context ${CC} --config="${KC}"
checkreturn

echo -e "\033[32mAll Success\033[0m"
echo The accounts are you give chuyu before\;for someone doesnt have accounts\,I display 6 accounts for you\: pm{1,2,3,4,5,6}/redhat
